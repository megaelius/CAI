Electricity prices and the end user net load vary with time. Electricity consumers equipped with
energy storage devices can perform energy arbitrage, i.e., buy when energy is cheap or when there
is a deficit of energy, and sell it when it is expensive or in excess, taking into account future variations
in price and net load. Net metering policies indicate that many of the utilities apply a {customer
selling} rate lower than or equal to the retail {customer buying rate} in order to compensate excess
energy generated by end users. In this paper, we formulate the optimal control problem for an end
user energy storage device in presence of net metering. We propose a computationally efficient
algorithm, with worst case run time complexity of quadratic in terms of number of samples in lookahead
horizon, that computes the optimal energy ramping rates in a time horizon. The proposed algorithm
exploits the problem's piecewise linear structure and convexity properties for the \textit{discretization}
of optimal Lagrange multipliers. The solution has a \textit{threshold-based structure} in which
optimal control decisions are independent of past or future price as well as of net load values beyond
a certain time horizon, defined as a \textit{sub-horizon}. Numerical results show the effectiveness
of the proposed model and algorithm. Furthermore, we investigate the impact of forecasting errors
on the proposed technique. We consider an Auto-Regressive Moving Average (ARMA) based forecasting
of net load together with the Model Predictive Control (MPC). We numerically show that adaptive
forecasting and MPC significantly mitigate the effects of forecast error on energy arbitrage gains.
