We theoretically study the nature of the correlated insulating states and the quantum anomalous
Hall (QAH) effect in twisted bilayer graphene (TBG) at the magic angle from the perspective of spontaneous
symmetry breaking. Using a generic unrestricted Hartree-Fock method applied to all the energy
bands, and including all the valley, spin, and sublattice dependence of the exchange interactions,
for the first time, we have successfully explained both the correlated insulating states at $\pm1/2$
fillings and the QAH effect at 3/4 filling of the flat bands. Our results indicate that the correlated
insulating states at $\pm1/2$ filling can be states with both valley polarized (VP) order and intervalley
coherent (IVC) order. The VP state breaks time-reversal ($\mathcal{T}$) symmetry, but still exhibits
vanishing anomalous Hall effect due to the combined $C_{2z}\mathcal{T}$ symmetry associated
with each valley. The IVC states break the valley charge conservation, which is massively degenerate
due to the separate spin $SU(2)$ symmetry operation of each valley and the valley $U(1)$ symmetry
operation. When a hexagonal boron nitride (hBN) substrate is aligned with the TBG, our calculations
show that the valley polarized states are energetically favored over the intervalley coherent
states at $\pm 1/2$ fillings, giving rise to QAH insulating states with Chern numbers ($C$) $\mp2$
(with opposite hysteresis loops) by virtue of the $C_{2z}$ symmetry breaking induced by the substrate.
Such valley polairzed $C=\pm2$ QAH states are orbital ferromagnetic and spin paramagnetic states,
which would be stablized by vertical magnetic fields, but would be strongly suppressed by in-plane
magnetic fields. Within the same theoretical framework, our calculations indicate that the $C\!=\!\mp
1$ QAH states at $\pm3/4$ filling of the magic-angle TBG would emerge only in the presence of hBN substrate.
